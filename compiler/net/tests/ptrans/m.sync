synch __M__ (__mrg__, __sm__ | __out__, __fb__)
{
  state int(32) seg_len, exp_len, depth;

  start {
    on:
      __mrg__ & [seg_len == (exp_len - 1)] {
        set seg_len = [0], exp_len = [-1];
        send this => __out__,
             @depth => __out__,
             (confirm : [1]) => __fb__;
      }

      __mrg__.else {
        set seg_len = [seg_len + 1];
        send this => __out__;
      }

      __sm__.(d, l) & [seg_len == l] {
        set seg_len = [0], exp_len = [-1];
        send @d => __out__,
             (confirm : [1]) => __fb__;
      }

      __sm__.(d, l) & [seg_len < l]  {
        set exp_len = [l], depth = [d];
      }
  }
}
