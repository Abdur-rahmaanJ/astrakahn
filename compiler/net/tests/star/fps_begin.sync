synch fps_begin (FPS_PORT, __fake__ | STAGE_IN, __bypass__, __output__)
{
  start {
    on:
      FPS_PORT.(ffp, rfp) & [ffp && !rfp] {
        send this => __output__;
      }

      FPS_PORT.(ffp, rfp) & [ffp && rfp] {
        send this => __output__;
      }

      FPS_PORT.(ffp, rfp) & [!ffp && rfp] {
        send this => STAGE_IN;
        goto bypass;
      }

    elseon:
      FPS_PORT.(ffp) & [ffp] {
        send this => __output__;
      }

      FPS_PORT.(rfp) & [rfp] {
        send this => STAGE_IN;
        goto bypass;
      }

      FPS_PORT.@d {
        send this => __bypass__;
      }

      FPS_PORT.else {
        send this => STAGE_IN;
      }
  }

  bypass {
    on:
      __fake__ { }
  }
}
